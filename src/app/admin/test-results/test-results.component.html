<!-- test-results.component.html -->

<div class="">
  <!-- Header -->
  <div
    class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-2"
  >
    <div>
      <h1 class="text-primary table-heading-detail">Test Results</h1>
      <!-- <p class="text-gray-500 mt-1">
        View and analyze test results and reports
      </p> -->
    </div>
    <div class="flex space-x-3">
      <button
        class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm"
      >
        Export Data
      </button>
      <button
        class="bg-[#1075bc] text-white hover:bg-[#1075bc] px-4 py-2 rounded-lg text-sm"
      >
        Generate Report
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white dark:bg-gray-800 rounded-lg p-4">
    <div class="flex flex-wrap gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Test Type</label
        >
        <select
          class="border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-900 text-gray-700 rounded-lg px-3 py-2 w-44"
        >
          <option value="">All Types</option>
          <option value="tensile">Tensile Strength</option>
          <option value="compression">Compression</option>
          <option value="hardness">Hardness</option>
          <option value="impact">Impact</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Status</label
        >
        <select
          class="border border-gray-300 bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-200 rounded-lg px-3 py-2 w-44"
        >
          <option value="">All</option>
          <option value="completed">Completed</option>
          <!-- <option value="failed">Failed</option> -->
          <option value="pending">Pending</option>
        </select>
      </div>

      <!-- <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Date Range</label
        >
        <input
          type="date"
          class="border border-gray-300 bg-white text-gray-700 rounded-lg px-3 py-2 w-40"
        />
      </div> -->

      <div class="flex items-end">
        <button
          class="bg-[#1075bc] text-white hover:[#1075bc] px-4 py-2 rounded-lg text-sm"
        >
          Apply Filters
        </button>
      </div>
    </div>
  </div>

  <div class="card border-0 mb-4 px-4 py-4">
    <div class="d-md-flex justify-content-between align-items-center my-3">
      <div class="d-flex align-items-center mb-md-0 mb-2">
        <span class="me-1 show-entery-text">Show</span>
        <select
          class="form-control form-select show-entries-select"
          (change)="onTableSizeChange($event)"
        >
          <option *ngFor="let size of tableSizes" [ngValue]="size">
            {{ size }}
          </option>
        </select>
        <span class="ms-1 show-entery-text">entries</span>
      </div>

      <div class="d-flex align-items-center">
        <form [formGroup]="searchbarform" class="d-flex align-items-center">
          <span class="me-1">Search:</span>
          <div
            [ngClass]="{'table-card table': searchbarform.controls['searchbar'].errors?.['required'] && (searchbarform.controls['searchbar'].touched || searchbarform.controls['searchbar'].dirty)}"
          >
            <input
              type="text"
              class="form-control search-user position-relative"
              autocomplete="off"
              formControlName="searchbar"
              [ngClass]="{
                'is-invalid':
                  searchbarform.controls['searchbar'].errors &&
                  (searchbarform.controls['searchbar'].touched ||
                    searchbarform.controls['searchbar'].dirty)
              }"
            />
            <div
              class="text-danger error-message d-block"
              *ngIf="
                searchbarform.controls['searchbar'].errors &&
                (searchbarform.controls['searchbar'].touched ||
                  searchbarform.controls['searchbar'].dirty)
              "
            >
              <p
                class="fw-light text-danger search-required"
                *ngIf="searchbarform.controls['searchbar'].errors['required']"
              >
                This is required
              </p>
            </div>
          </div>
          <button class="btn btn-primary search-btn ms-2" (click)="searchfun()">
            <span
              ><i class="fa-solid fa-magnifying-glass form-control-feedback"></i
            ></span>
          </button>
          <button
            class="btn btn-primary search-btn ms-2"
            (click)="resetsearchbar()"
            type="submit"
            *ngIf="showreset == true"
          >
            <span
              ><i class="fa-solid fa-rotate-right form-control-feedback"></i
            ></span>
          </button>
        </form>
      </div>
    </div>
    <div class="table-responsive-sm">
      <table class="table table-bordered table-hover table-striped mb-0">
        <thead class="table-header">
          <tr>
            <th>
              <p class="table-heading">Test ID</p>
            </th>
            <th>
              <p class="table-heading">Test Name</p>
            </th>
            <!-- <th>
              <p class="table-heading">{{ detail.heading22 }}</p>
            </th> -->
            <th>
              <p class="table-heading">Type</p>
            </th>

            <th>
              <p class="table-heading">Date</p>
            </th>
            <th>
              <p class="table-heading">Operator</p>
            </th>
            <th>
              <p class="table-heading">Status</p>
            </th>
            <th>
              <p class="table-heading">Actions</p>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let result of testResults
                | paginate
                  : {
                      itemsPerPage:
                        tableSize != 'all' ? tableSize : totalRecords,
                      currentPage: page,
                      totalItems: totalRecords
                    };
              index as i
            "
          >
            <td>{{ result.id }}</td>
            <td>
              <p>{{ result.testName }}</p>
            </td>
            <!-- <td>
              <p>{{ test.testMaterial }}</p>
            </td> -->
            <td>
              <p>{{ result.testType }}</p>
            </td>

            <td>
              <p>
                {{ result.completedDate | date : "yyyy-MM-dd" }}
              </p>
            </td>
            <td>
              <p>{{ result.operator }}</p>
            </td>

            <td>
              <p>
                <td class="py-3 px-4 text-gray-600">
                  <span
                    class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                    [ngClass]="{
                      'bg-green-100 text-green-800':
                        result.status === 'completed',

                      'bg-yellow-100 text-yellow-800':
                        result.status === 'pending'
                    }"
                  >
                    {{ result.status | titlecase }}
                  </span>
                </td>
              </p>
            </td>
            <td>
              <p>
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <!-- <button mat-menu-item (click)="viewDetails(result)">
                    Edit
                  </button> -->
                  <button mat-menu-item (click)="viewDetails(result)">
                    View
                  </button>
                </mat-menu>
              </p>
            </td>
          </tr>
        </tbody>
      </table>
      <div
        class="d-md-flex justify-content-between bottom-0 end-0 py-2 align-items-center"
      >
        <span class="showalltext"
          >Showing
          {{ tableSize * (page - 1) > 0 ? tableSize * (page - 1) + 1 : 1 }} to
          {{
            tableSize * page <= totalRecords ? tableSize * page : totalRecords
          }}
          of {{ totalRecords != undefined ? totalRecords : "" }} entries</span
        >
        <pagination-controls
          previousLabel="Prev"
          nextLabel="Next"
          [responsive]="true"
          (pageChange)="onTableDataChange($event)"
          target="_top"
        ></pagination-controls>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div
    *ngIf="selectedResult"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div
      class="bg-white dark:bg-gray-900 rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[80vh] overflow-y-auto"
    >
      <div class="flex justify-between items-center mb-6">
        <p class="text-2xl font-bold text-gray-800">Test Results Details</p>
        <button
          (click)="closeDetails()"
          class="text-gray-400 hover:text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-4">
          <p class="text-lg font-semibold text-gray-800">Test Information</p>
          <div class="space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-600">Test ID:</span>
              <span class="font-mono text-gray-900">{{
                selectedResult.id
              }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Test Name:</span>
              <span class="text-gray-900">{{ selectedResult.testName }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Sample ID:</span>
              <span class="font-mono text-gray-900">{{
                selectedResult.sampleId
              }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Date:</span>
              <span class="text-gray-900">{{
                selectedResult.completedDate | date : "mediumDate"
              }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Operator:</span>
              <span class="text-gray-900">{{ selectedResult.operator }}</span>
            </div>
          </div>
        </div>
        <div class="space-y-4">
          <p class="text-lg font-semibold text-gray-800">Measured Values</p>
          <div class="space-y-2">
            <div
              *ngFor="let item of getResultEntries(selectedResult.results)"
              class="flex justify-between"
            >
              <span class="text-gray-600">{{ item.key }}:</span>
              <span class="text-gray-900 font-medium">{{ item.value }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-6 flex justify-end space-x-3">
        <button
          class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm"
          (click)="closeDetails()"
        >
          Close
        </button>
        <button
          class="bg-blue-600 text-white hover:bg-blue-700 px-4 py-2 rounded-lg text-sm"
        >
          Download Report
        </button>
      </div>
    </div>
  </div>
</div>
