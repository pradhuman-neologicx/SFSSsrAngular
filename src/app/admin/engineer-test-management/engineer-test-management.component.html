<div class="container-fluid mb-4">
  <div class="d-md-flex justify-content-between align-items-center mb-4">
    <h1 class="text-primary table-heading-detail">Test Management</h1>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a
        class="nav-link cursor-pointer"
        [class.active]="activeTab === 'assigned'"
        (click)="setActiveTab('assigned')"
        >Assigned</a
      >
    </li>
    <li class="nav-item">
      <a
        class="nav-link cursor-pointer"
        [class.active]="activeTab === 'completed'"
        (click)="setActiveTab('completed')"
        >Completed</a
      >
    </li>
  </ul>

  <!-- Assigned Tab -->
  <div *ngIf="activeTab === 'assigned'" class="card border-0 mb-4 px-4 py-4">
    <div class="d-md-flex justify-content-between align-items-center my-3">
      <div class="d-flex align-items-center mb-md-0 mb-2">
        <span class="me-1 show-entery-text">Show</span>
        <select
          class="form-control form-select show-entries-select"
          (change)="onTableSizeChange($event)"
        >
          <option *ngFor="let size of tableSizes" [ngValue]="size">
            {{ size }}
          </option>
        </select>
        <span class="ms-1 show-entery-text">entries</span>
      </div>
      <div class="d-flex align-items-center">
        <form [formGroup]="searchbarform" class="d-flex align-items-center">
          <span class="me-1">Search:</span>
          <div
            [ngClass]="{
              'table-card table':
                searchbarform.controls['searchbar'].errors?.['required'] &&
                (searchbarform.controls['searchbar'].touched ||
                  searchbarform.controls['searchbar'].dirty)
            }"
          >
            <input
              type="text"
              class="form-control search-user position-relative"
              autocomplete="off"
              formControlName="searchbar"
              [ngClass]="{
                'is-invalid':
                  searchbarform.controls['searchbar'].errors &&
                  (searchbarform.controls['searchbar'].touched ||
                    searchbarform.controls['searchbar'].dirty)
              }"
            />
            <div
              class="text-danger error-message d-block"
              *ngIf="
                searchbarform.controls['searchbar'].errors &&
                (searchbarform.controls['searchbar'].touched ||
                  searchbarform.controls['searchbar'].dirty)
              "
            >
              <p
                class="fw-light text-danger search-required"
                *ngIf="searchbarform.controls['searchbar'].errors['required']"
              >
                This is required
              </p>
            </div>
          </div>
          <button class="btn btn-primary search-btn ms-2" (click)="searchfun()">
            <span
              ><i class="fa-solid fa-magnifying-glass form-control-feedback"></i
            ></span>
          </button>
          <button
            class="btn btn-primary search-btn ms-2"
            (click)="resetsearchbar()"
            type="submit"
            *ngIf="showreset"
          >
            <span
              ><i class="fa-solid fa-rotate-right form-control-feedback"></i
            ></span>
          </button>
        </form>
      </div>
    </div>
    <div class="table-responsive-sm">
      <table class="table table-bordered table-hover table-striped mb-0">
        <thead class="table-header">
          <tr>
            <th><p class="table-heading">Test Name</p></th>
            <th><p class="table-heading">Client Name</p></th>
            <th><p class="table-heading">Test In</p></th>
            <th><p class="table-heading">Assigned To</p></th>
            <th><p class="table-heading">Action</p></th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let test of assignedTests
                | paginate
                  : {
                      itemsPerPage:
                        tableSize != 'all' ? tableSize : totalRecordsAssigned,
                      currentPage: pageAssigned,
                      totalItems: totalRecordsAssigned
                    };
              index as i
            "
          >
            <td>
              <p>{{ test.test_number }}</p>
            </td>
            <td>
              <p>{{ test.customer.name }}</p>
            </td>
            <td>
              <p>{{ test.created_at | date : "dd-MM-yyyy" }}</p>
            </td>
            <td>
              <p>{{ test.assigned_user.name }}</p>
            </td>
            <td>
              <p>
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <button
                    mat-menu-item
                    (click)="openCompleteTestModal(test.id)"
                  >
                    Complete
                  </button>

                  <button mat-menu-item (click)="openFillDetailsModal(test)">
                    Fill Test Details
                  </button>
                  <!-- <button mat-menu-item (click)="openViewModal(test)">
                    View Details
                  </button> -->
                </mat-menu>
              </p>
            </td>
          </tr>
        </tbody>
      </table>
      <div
        class="d-md-flex justify-content-between bottom-0 end-0 py-2 align-items-center"
      >
        <span class="showalltext"
          >Showing
          {{
            tableSize * (pageAssigned - 1) > 0
              ? tableSize * (pageAssigned - 1) + 1
              : 1
          }}
          to
          {{
            tableSize * pageAssigned <= totalRecordsAssigned
              ? tableSize * pageAssigned
              : totalRecordsAssigned
          }}
          of
          {{ totalRecordsAssigned != undefined ? totalRecordsAssigned : "" }}
          entries</span
        >
        <pagination-controls
          previousLabel="Prev"
          nextLabel="Next"
          [responsive]="true"
          (pageChange)="onTableDataChangeAssigned($event)"
          target="_top"
        ></pagination-controls>
      </div>
    </div>
  </div>

  <!-- Completed Tab -->
  <div *ngIf="activeTab === 'completed'" class="card border-0 mb-4 px-4 py-4">
    <div class="d-md-flex justify-content-between align-items-center my-3">
      <div class="d-flex align-items-center mb-md-0 mb-2">
        <span class="me-1 show-entery-text">Show</span>
        <select
          class="form-control form-select show-entries-select"
          (change)="onTableSizeChange($event)"
        >
          <option *ngFor="let size of tableSizes" [ngValue]="size">
            {{ size }}
          </option>
        </select>
        <span class="ms-1 show-entery-text">entries</span>
      </div>
      <div class="d-flex align-items-center">
        <form [formGroup]="searchbarform" class="d-flex align-items-center">
          <span class="me-1">Search:</span>
          <div
            [ngClass]="{
              'table-card table':
                searchbarform.controls['searchbar'].errors?.['required'] &&
                (searchbarform.controls['searchbar'].touched ||
                  searchbarform.controls['searchbar'].dirty)
            }"
          >
            <input
              type="text"
              class="form-control search-user position-relative"
              autocomplete="off"
              formControlName="searchbar"
              [ngClass]="{
                'is-invalid':
                  searchbarform.controls['searchbar'].errors &&
                  (searchbarform.controls['searchbar'].touched ||
                    searchbarform.controls['searchbar'].dirty)
              }"
            />
            <div
              class="text-danger error-message d-block"
              *ngIf="
                searchbarform.controls['searchbar'].errors &&
                (searchbarform.controls['searchbar'].touched ||
                  searchbarform.controls['searchbar'].dirty)
              "
            >
              <p
                class="fw-light text-danger search-required"
                *ngIf="searchbarform.controls['searchbar'].errors['required']"
              >
                This is required
              </p>
            </div>
          </div>
          <button class="btn btn-primary search-btn ms-2" (click)="searchfun()">
            <span
              ><i class="fa-solid fa-magnifying-glass form-control-feedback"></i
            ></span>
          </button>
          <button
            class="btn btn-primary search-btn ms-2"
            (click)="resetsearchbar()"
            type="submit"
            *ngIf="showreset"
          >
            <span
              ><i class="fa-solid fa-rotate-right form-control-feedback"></i
            ></span>
          </button>
        </form>
      </div>
    </div>
    <div class="table-responsive-sm">
      <table class="table table-bordered table-hover table-striped mb-0">
        <thead class="table-header">
          <tr>
            <th><p class="table-heading">Test Name</p></th>
            <th><p class="table-heading">Client Name</p></th>
            <th><p class="table-heading">Test In</p></th>
            <th><p class="table-heading">Assigned To</p></th>
            <th><p class="table-heading">Delivery Date</p></th>
            <!-- <th><p class="table-heading">Action</p></th> -->
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let test of completedTests
                | paginate
                  : {
                      itemsPerPage:
                        tableSize != 'all' ? tableSize : totalRecordsCompleted,
                      currentPage: pageCompleted,
                      totalItems: totalRecordsCompleted
                    };
              index as i
            "
          >
            <td>
              <p>{{ test.test_number }}</p>
            </td>
            <td>
              <p>{{ test.customer.name }}</p>
            </td>
            <td>
              <p>{{ test.created_at | date : "dd-MM-yyyy" }}</p>
            </td>
            <td>
              <p>{{ test.assigned_user.name }}</p>
            </td>
            <td>
              <p>{{ test.expected_delivery_date | date : "dd-MM-yyyy" }}</p>
            </td>
            <!-- <td>
              <p>
                <button mat-icon-button [matMenuTriggerFor]="menu">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                  <button mat-menu-item (click)="openViewModal(test)">
                    View Details
                  </button>
                </mat-menu>
              </p>
            </td> -->
          </tr>
        </tbody>
      </table>
      <div
        class="d-md-flex justify-content-between bottom-0 end-0 py-2 align-items-center"
      >
        <span class="showalltext"
          >Showing
          {{
            tableSize * (pageCompleted - 1) > 0
              ? tableSize * (pageCompleted - 1) + 1
              : 1
          }}
          to
          {{
            tableSize * pageCompleted <= totalRecordsCompleted
              ? tableSize * pageCompleted
              : totalRecordsCompleted
          }}
          of
          {{ totalRecordsCompleted != undefined ? totalRecordsCompleted : "" }}
          entries</span
        >
        <pagination-controls
          previousLabel="Prev"
          nextLabel="Next"
          [responsive]="true"
          (pageChange)="onTableDataChangeCompleted($event)"
          target="_top"
        ></pagination-controls>
      </div>
    </div>
  </div>

  <!-- View Test Modal -->
  <div
    *ngIf="testViewOpen"
    class="your-animation-class modal-container"
    aria-labelledby="modal-Test"
    role="dialog"
    aria-modal="true"
  >
    <div class="modal-content modal-content-50" [@fadeIn]>
      <div (click)="clickModalContent($event)">
        <form [formGroup]="testViewForm">
          <div class="card">
            <div
              class="card-header bg-white d-flex justify-content-between align-items-center"
            >
              <h5 class="modal-title pt-1">View Test</h5>
              <button
                class="btn btn-primary main-btn bg-transparent border-0 pb-0 pt-1 text-black"
                type="button"
                (click)="closeModal()"
              >
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            <div class="modal-content-width card-body mb-0 pb-0">
              <div class="row">
                <div class="col-lg-12 col-md-12 mb-3">
                  <label
                    class="d-block text-capitalize form-label admin-form-lable"
                    for="test_name"
                    >Test Name</label
                  >
                  <input
                    type="text"
                    class="d-block form-control form-input-custom"
                    formControlName="test_name"
                    [readOnly]="true"
                  />
                </div>
                <div class="col-lg-12 col-md-12 mb-3">
                  <label
                    class="d-block text-capitalize form-label admin-form-lable"
                    for="client_name"
                    >Client Name</label
                  >
                  <input
                    type="text"
                    class="d-block form-control form-input-custom"
                    formControlName="client_name"
                    [readOnly]="true"
                  />
                </div>
                <div class="col-lg-12 col-md-12 mb-3">
                  <label
                    class="d-block text-capitalize form-label admin-form-lable"
                    for="test_in"
                    >Test In Date</label
                  >
                  <input
                    type="text"
                    class="d-block form-control form-input-custom"
                    formControlName="test_in"
                    [readOnly]="true"
                  />
                </div>
                <div
                  class="col-lg-12 col-md-12 mb-3"
                  *ngIf="testViewForm.controls['assigned_to_name']"
                >
                  <label
                    class="d-block text-capitalize form-label admin-form-lable"
                    for="assigned_to_name"
                    >Assigned To</label
                  >
                  <input
                    type="text"
                    class="d-block form-control form-input-custom"
                    formControlName="assigned_to_name"
                    [readOnly]="true"
                  />
                </div>
                <div
                  class="col-lg-12 col-md-12 mb-3"
                  *ngIf="testViewForm.controls['completed_on']"
                >
                  <label
                    class="d-block text-capitalize form-label admin-form-lable"
                    for="completed_on"
                    >Completed On</label
                  >
                  <input
                    type="text"
                    class="d-block form-control form-input-custom"
                    formControlName="completed_on"
                    [readOnly]="true"
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer text-end mb-4 me-4">
              <button
                class="btn btn-secondary main-btnfs px-4 py-2 text-gray-100"
                type="button"
                (click)="closeModal()"
              >
                Cancel
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div
    *ngIf="openSuccessMessage"
    class="your-animation-class modal-container-success"
    [@slideIn]
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
  >
    <div>
      <div
        class="p-4 d-flex justify-content-between align-items-center success-content"
      >
        <span class="icon-success me-2"><i class="fa-solid fa-check"></i></span>
        <p class="text-green-900 text-capitalize mb-0">
          {{ successMessage }} successfully
        </p>
      </div>
    </div>
  </div>
</div>
<!-- Fill Test Details Modal -->
<div
  *ngIf="fillDetailsModalOpen"
  class="your-animation-class modal-container modal-FillDetailsContainer"
  aria-labelledby="modal-FillDetails"
  role="dialog"
  aria-modal="true"
>
  <div class="modal-content w-3/4" [@fadeIn]>
    <div (click)="clickModalContent($event)">
      <form [formGroup]="fillDetailsForm">
        <div class="card">
          <div
            class="card-header bg-white d-flex justify-content-between align-items-center"
          >
            <h5 class="modal-title pt-1">Fill Test Details</h5>
            <button
              class="btn btn-primary main-btn bg-transparent border-0 pb-0 pt-1 text-black"
              type="button"
              (click)="closeFillDetailsModal()"
            >
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div class="modal-content-width card-body mb-0 pb-0">
            <div class="row">
              <div class="col-12 mb-3">
                <h5 class="headingdeatils">Test Requests</h5>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-2">
                  <div class="flex">
                    <span class="font-semibold w-36">Test Request #:</span>
                    <span>{{ currentTest?.id }}</span>
                  </div>
                  <div class="flex">
                    <span class="font-semibold w-24">User:</span>
                    <span>{{ currentTest?.customer?.name }}</span>
                  </div>
                  <div class="flex">
                    <span class="font-semibold w-36">Project:</span>
                    <span>{{ currentTest?.work_name }}</span>
                  </div>
                  <div class="flex">
                    <span class="font-semibold w-24">Engineer:</span>
                    <span>{{ currentTest?.assigned_to?.name }}</span>
                  </div>
                </div>
              </div>
              <div class="col-12" *ngIf="materials.length > 0">
                <h5 class="headingdeatils">Material-Based Tests</h5>
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Material</th>
                      <th>Sample ID</th>
                      <th>Test Name</th>
                      <th>Input Fields</th>
                      <th>Result</th>
                      <th>Units</th>
                      <th>Remarks</th>
                    </tr>
                  </thead>
                  <tbody>
                    <ng-container *ngFor="let material of materials">
                      <ng-container
                        *ngFor="
                          let testConfig of material.tests;
                          let tIdx = index
                        "
                      >
                        <ng-container
                          *ngFor="
                            let inputField of testConfig.input_fields;
                            let iIdx = index
                          "
                        >
                          <tr>
                            <!-- Material column: rowspan for all input fields of all tests -->
                            <td
                              *ngIf="tIdx === 0 && iIdx === 0"
                              [attr.rowspan]="getMaterialRowspan(material)"
                            >
                              {{ material.material_name }}
                            </td>
                            <!-- Sample ID column: rowspan for all input fields of all tests -->
                            <td
                              *ngIf="tIdx === 0 && iIdx === 0"
                              [attr.rowspan]="getMaterialRowspan(material)"
                            >
                              {{ material.sample_id }}
                            </td>
                            <!-- Test Name column: rowspan for all input fields of this test -->
                            <td
                              *ngIf="iIdx === 0"
                              [attr.rowspan]="
                                testConfig.input_fields?.length || 1
                              "
                            >
                              {{ testConfig.test_name }}
                            </td>
                            <!-- Input Field Name -->
                            <td>{{ inputField.input_field_name }}</td>
                            <!-- Result Input -->
                            <td>
                              <input
                                type="text"
                                [formControlName]="
                                  'material_' +
                                  material.material_id +
                                  '_test_' +
                                  testConfig.test_configuration_id +
                                  '_input_' +
                                  inputField.id
                                "
                                class="form-control"
                                placeholder="Enter value"
                              />
                            </td>
                            <!-- Unit -->
                            <td>{{ inputField.uom_name }}</td>
                            <td>
                              <input
                                type="text"
                                [formControlName]="
                                  'material_' +
                                  material.material_id +
                                  '_test_' +
                                  testConfig.test_configuration_id +
                                  '_remarks_' +
                                  inputField.id
                                "
                                class="form-control"
                                placeholder="Enter remarks"
                              />
                            </td>
                          </tr>
                        </ng-container>
                      </ng-container>
                    </ng-container>
                  </tbody>
                </table>
              </div>
              <div class="col-12" *ngIf="fields.length > 0">
                <h5 class="headingdeatils">Field-Based Tests</h5>
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Test Name</th>
                      <th>Sample ID</th>
                      <th>Input Fields</th>
                      <th>Result</th>
                      <th>Unit</th>
                      <th>Remarks</th>
                    </tr>
                  </thead>
                  <tbody>
                    <ng-container *ngFor="let field of fields">
                      <tr
                        *ngFor="
                          let inputField of field.input_fields;
                          let i = index
                        "
                      >
                        <td
                          *ngIf="i === 0"
                          [attr.rowspan]="field.input_fields.length"
                        >
                          {{ field.test_name }}
                        </td>
                        <td
                          *ngIf="i === 0"
                          [attr.rowspan]="field.input_fields.length"
                        >
                          {{ field.sample_id }}
                        </td>
                        <td>{{ inputField.input_field_name }}</td>
                        <td>
                          <input
                            type="text"
                            [formControlName]="
                              getControlName(
                                field.field_id,
                                inputField.input_field_name
                              )
                            "
                            class="form-control"
                            placeholder="Enter values"
                          />
                        </td>
                        <td>{{ inputField.uom_name }}</td>
                        <td>
                          <input
                            type="text"
                            [formControlName]="
                              'field_' +
                              field.field_id +
                              '_remarks_' +
                              inputField.id
                            "
                            class="form-control"
                            placeholder="Enter remarks"
                          />
                        </td>
                      </tr>
                    </ng-container>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer text-end me-4 mb-3">
            <button
              class="btn btn-secondary main-btnfs px-4 py-2 me-4 text-gray-100"
              type="button"
              (click)="closeFillDetailsModal()"
            >
              Cancel
            </button>
            <button
              class="btn btn-custom-primary px-4 py-2"
              type="submit"
              (click)="saveTestDetails()"
            >
              Submit
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- delete test modal for confirmation -->
<div
  *ngIf="deleteTestModalOpen"
  class="your-animation-class modal-containerDelete"
  aria-labelledby="modal-DeleteTest"
  role="dialog"
  aria-modal="true"
>
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="modal-DeleteTest">Delete Test</h5>
      <button
        type="button"
        class="btn-close"
        aria-label="Close"
        (click)="closeDeleteTestModal()"
      ></button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to delete this test?</p>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="closeDeleteTestModal()"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-danger"
        (click)="deleteTest(testIdToDelete)"
      >
        Delete
      </button>
    </div>
  </div>
</div>
<!-- Complete test modal for confirmation -->
<div
  *ngIf="completeTestModalOpen"
  class="your-animation-class modal-containerDelete"
  aria-labelledby="modal-DeleteTest"
  role="dialog"
  aria-modal="true"
>
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="modal-DeleteTest">Complete Test</h5>
      <button
        type="button"
        class="btn-close"
        aria-label="Close"
        (click)="closeCompleteTestModal()"
      ></button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to complete this test?</p>
    </div>
    <div class="modal-footer">
      <button
        type="button"
        class="btn btn-secondary"
        (click)="closeCompleteTestModal()"
      >
        Cancel
      </button>
      <button
        type="button"
        class="btn btn-success"
        (click)="completeTest(testIdToComplete)"
      >
        Complete
      </button>
    </div>
  </div>
</div>
